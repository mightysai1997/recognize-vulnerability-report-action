import {Vulnerability} from '../models/vulnerability'
import {VulnerabilitySeverity} from '../models/vulnerability-severity'
import {capitalize} from '../utils/capitalize'
import {countVulnerabilities} from '../utils/count-vulnerabilities'
import {sortVulnerabilities} from '../utils/sort-vulnerabilities'

export const createMarkdownReport = (
  openVulnerabilities: Vulnerability[]
): string => {
  const sortedVulnerabilities = sortVulnerabilities(openVulnerabilities)

  return `
# ðŸ¤– Vulnerability Report
${Object.values(VulnerabilitySeverity)
  .map(
    severity =>
      `* **${capitalize(severity)}:** ${countVulnerabilities(
        openVulnerabilities,
        severity
      )} vulnerabilities`
  )
  .join('\n')}
    
<details>
    <summary>View details</summary>
      
${sortedVulnerabilities
  .map(
    it =>
      `* **(${it.securityVulnerability.severity.toLowerCase()})** [${it.securityVulnerability.package.ecosystem.toLowerCase()}] ${
        it.securityVulnerability.package.name
      } - ${it.securityAdvisory.summary}`
  )
  .join('\n')}
</details>
`.trim()
}
